name: run-digger
description: Manage terraform collaboration
author: Digger

outputs:
  output:
    value: ${{ steps.digger.outputs.output }}
    description: The terraform output

runs:
  using: composite
  steps:
    - name: build and run digger
      if: ${{ !startsWith(github.action_ref, 'v') }}
      shell: bash
      run: |
          cd ${{ github.action_path }}
          go build -o digger ./cmd/digger
          chmod +x digger
          mv digger /usr/local/bin/digger
          cd ${{ github.workspace }}
          digger
    - name: run digger
      if: ${{ startsWith(github.action_ref, 'v') }}
      env:
        actionref: ${{ github.action_ref }}
      id: digger
      shell: bash
      run: |
        curl -sL https://github.com/diggerhq/digger/releases/download/${actionref}/digger-${{ runner.os  }}-${{ runner.arch }} -o digger
        chmod +x digger
        mv digger /usr/local/bin/digger
        cd ${{ github.workspace }}
        digger
    - name: generate artifact name based on issue number
      if: ${{ github.event_name == 'issue_comment' }}
      id: artifact
      shell: bash
      run: |
          echo "::set-output name=artifact::plans-${{ github.event.issue.number }}"
    - name: generate artifact name based on pull request number
      if: ${{ github.event_name != 'issue_comment' }}
      id: artifact
      shell: bash
      run: |
          echo "::set-output name=artifact::plans-${{ github.pull_request.number }}"
    - name: upload plan
      uses: actions/upload-artifact@v3
      with:
          name: ${{ steps.artifact.outputs.artifact }}
          path: '*.tfplan'
          retention-days: 14

branding:
  icon: globe
  color: purple
